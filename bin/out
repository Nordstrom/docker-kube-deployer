#!/bin/bash
set -e
set -o pipefail
exec 3>&1 # use fd 3 for script output
exec 1>&2 # send normal stdout to stderr for logging
cat /dev/stdin > /tmp/input

TOKEN=$(jq -r .source.token < /tmp/input)
KUBE_URL=$(jq -r .source.kube_utl < /tmp/input)
jq -r .source.ca_cert < /tmp/input > ~/.kube/ca.pem

kubectl config set-cluster platform --server=$KUBE_URL --certificate-authority=${HOME}/.kube/ca.pem
kubectl config set-credentials ci --token=$TOKEN
kubectl config set-context platform --cluster=platform --user=ci
kubectl config use-context platform

make deploy
